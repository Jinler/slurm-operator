Bootstrap: docker
From: golang:alpine
Stage: builder

%setup
	mkdir -p ${SINGULARITY_ROOTFS}/usr/local/go/src/github.com/sylabs/slurm-operator

%files
    . /usr/local/go/src/github.com/sylabs/slurm-operator

%post
	export PATH=$PATH:/usr/local/go/bin
	export HOME=/root
	export GOPATH=/go

    apk update
    apk add git && apk add ca-certificates
    adduser -D -g '' appuser
    cd /usr/local/go/src/github.com/sylabs/slurm-operator
    CGO_ENABLED=0 go build -o main cmd/job-companion/main.go

Bootstrap: scratch
Stage: two

%setup
	mkdir -p ${SINGULARITY_ROOTFS}/etc/ssl/certs
	mkdir -p ${SINGULARITY_ROOTFS}/app

%files from builder
    /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
    /etc/passwd /etc/passwd
    /usr/local/go/src/github.com/sylabs/slurm-operator/main /app/

%runscript
    cd /app
    su - appuser
    main
